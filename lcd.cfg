#####################################################################
#  Displays
#####################################################################
[display]
##  mini12864 LCD Display
lcd_type: uc1701
rst_pin: P3.25
cs_pin: P3.26
a0_pin: P1.30
encoder_pins: ^P1.22,^P1.31
click_pin: ^!P1.0
contrast: 42
menu_timeout: 30
display_group: __voron_display

[neopixel neo_display]
##	To control Neopixel RGBW 
pin: P1.18
chain_count: 26
color_order: GRBW
initial_RED: 0.8
initial_GREEN: 0.8
initial_BLUE: 1.0
initial_WHITE: 0.8

#####################################################################
# 	Glyph definition
#####################################################################
[display_glyph chamber]
data:
    0000000000000000
    1111111111111111
    1000010000100001
    1000010000100001
    1000011111100001
    1000000000000001
    1000000000000001
    1000001111000001
    1011101001011101
    1000001111000001
    1000000110000001
    1000000000000001
    1011111111111101
    1000100000010001
    1111111111111111
    0000000000000000
    
[display_glyph voron]
data:
    1111111001111111
    1111100000011111
    1111000000001111
    1100000000000011
    1000001100110001
    1000011001100001
    1000110011000001
    1001100110000001
    1000000110011001
    1000001100110001
    1000011001100001
    1000110011000001
    1110000000000111
    1111000000001111
    1111100000011111
    1111111001111111

[display_glyph voroninv]
data:
    0000001110000000
    0000111111100000
    0001111111110000
    0111111111111100
    1111100111001110
    1111001110011110
    1110011100111110
    1100111001111110
    1111110011100110
    1111100111001110
    1111001110011110
    1110011100111110
    0111111111111100
    0001111111110000
    0000111111100000
    0000001110000000
    
#####################################################################
# 	Display Data definition
#####################################################################
[display_template _vheater_temperature]
param_heater_name: "extruder"
text:
  {% if param_heater_name in printer %}
    {% set heater = printer[param_heater_name] %}
    # Show glyph
    {% if param_heater_name == "heater_bed" %}
      {% if heater.target %}
        {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
        ~bed_heat{frame}~
      {% else %}
        ~bed~
      {% endif %}
    {% else %}
      ~extruder~
    {% endif %}
    # Show temperature
    { "%3.0f" % (heater.temperature,) }
    # Optionally show target
    {% if heater.target and (heater.temperature - heater.target)|abs > 2 %}
      ~right_arrow~
      { "%0.0f" % (heater.target,) }
    {% endif %}
    ~degrees~
  {% endif %}

[display_data __voron_display extruder]
position: 0, 0
text: { render("_vheater_temperature", param_heater_name="extruder") }

[display_data __voron_display fan]
position: 0, 10
text:
  {% if 'fan' in printer %}
    {% set speed = printer.fan.speed %}
    {% if speed %}
      {% set frame = (printer.toolhead.estimated_print_time|int % 2) + 1 %}
      ~fan{frame}~
    {% else %}
      ~fan1~
    {% endif %}
    { "{:>4.0%}".format(speed) }
  {% endif %}

[display_data __voron_display bed]
position: 1, 0
text: { render("_vheater_temperature", param_heater_name="heater_bed") }

[display_data __voron_display progress_text]
position: 1, 10
text:
  {% set progress = printer.virtual_sdcard.progress %}
  { "{:^6.0%}".format(progress) }
  
[display_data __voron_display progress_text2]
position: 1, 10
text:
  {% set progress = printer.virtual_sdcard.progress %}
  { draw_progress_bar(1, 10, 6, progress) }

[display_data __voron_display printing_time]
position: 2, 10
text:
  {% set ptime = printer.print_stats.total_duration %}
  { "%02d:%02d" % (ptime // (60 * 60), (ptime // 60) % 60) }

[display_data __voron_display chamber]
position: 2, 0
text:
  {% set chamber = printer['temperature_sensor bed'] %}
	~chamber~
	{ "%3.0f" % (chamber.temperature) }
	 ~degrees~

[display_data __voron_display print_status]
position: 3, 0
text: 
  {% if printer.display_status.message %}
    { printer.display_status.message }
  {% elif printer.idle_timeout.printing_time|int != 0 %}
    {% set pos = printer.toolhead.position %}
    { "X%-4.0fY%-4.0fZ%-5.2f" % (pos.x, pos.y, pos.z) }
  {% else %}
  #  { "V2.660 " }
	#~voron~
  {% endif %}
  
#####################################################################
# 	LCD Macro
#####################################################################
[delayed_gcode _LCD_INIT_KNOB]
initial_duration: 1
gcode:
  ##### get hardware enables #####
  {% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
  ##### end of definiton #####
  {% if ena_neo == 'true' %} _LCD_KNOB COLOR=GREEN SYNC=0 {% endif %}
  
[delayed_gcode _LCD_INIT_OFF]
initial_duration: 10
gcode:
  ##### get hardware enables #####
  {% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
  ##### switch off if not already in menu #####
  {% if printer.menu.running|lower == 'false' and ena_neo == 'true' %}
    SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"off"'
    SET_LED LED=neo_display RED=0 GREEN=0 BLUE=0 WHITE=0 TRANSMIT=1 SYNC=0
  {% endif %}

[gcode_macro _LCD_KNOB]
description: Helper: Set LCD Knob color
# array is defined: [ R ,  G ,  B ,  W ]
variable_pri_color: [0.0, 0.3, 0.0, 0.0]    ; primary color will be used for restore 
variable_sec_color: [0.0, 0.0, 0.0, 0.0]    ; secondary color for blinking always off
variable_res_color: [0.0, 0.3, 0.0, 0.0]    ; restore color will be used as primary 
variable_index: 2                           ; used for blinking
variable_time: 0                            ; timeinterval for blinking
variable_sync: 1                            ; decide if the LED needs to be sync with movement queue 
gcode:
  ##### color definition #####
  # array is defined: [  name ,  R ,  G  , B ,  W ]
  {% set def_color = [('OFF'  , 0.0, 0.0, 0.0, 0.0),
                      ('GREEN', 0.0, 0.3, 0.0, 0.0),
                      ('RED'  , 0.5, 0.0, 0.0, 0.0),
                      ('BLUE' , 0.0, 0.0, 0.5, 0.0),
                      ('WHITE', 0.0, 0.0, 0.0, 0.5)] %}
#variable_colors: { 'orange': (1.0, 0.5, 0.0, 0.0),
  #              'yellow': (1.0, 1.0, 0.0, 0.0),
   #          'charteuse': (0.5, 1.0, 0.0, 0.0),
     #        'turquiose': (0.0, 1.0, 0.5, 0.0),
      #     'springgreen': (0.0, 1.0, 0.5, 0.0),
       #           'cyan': (0.0, 1.0, 1.0, 0.0),
        #         'azure': (0.0, 0.5, 1.0, 0.0),
         #        'ocean': (0.0, 0.5, 1.0, 0.0),
           #     'violet': (0.5, 0.0, 1.0, 0.0),
            #    'purple': (0.5, 0.0, 1.0, 0.0),
             #  'magenta': (1.0, 0.0, 1.0, 0.0),
             #'raspberry': (1.0, 0.0, 0.5, 0.0),
              #    'rose': (1.0, 0.0, 0.5, 0.0),
               #  'white': (0.0, 0.0, 0.0, 1.0),
                #   'off': (0.0, 0.0, 0.0, 0.0) }
  
  ##### get default parameter value #####
  {% set time = params.BLINK|default(0)|float %}
  {% set sync = params.SYNC|default(0)|int %}
  ##### get values of requested color ##### 
  {% if params and COLOR in params|upper %}
    {% set elem_cnt = def_color|length %}
    {% set ns = namespace(elem = elem_cnt) %}
    {% for cnt in range(elem_cnt) %}
      {% if def_color[cnt][0]|upper == params.COLOR|upper %}
         {% set ns.elem = cnt %}
      {% endif %}
    {% endfor %}
    {% if ns.elem < elem_cnt %}
       {% set col = [def_color[ns.elem][1],def_color[ns.elem][2],def_color[ns.elem][3],def_color[ns.elem][4]] %}
    {% else %}
      {action_respond_info("LCD KNOB COLOR %s is not defined used default: GREEN" % (params.COLOR|upper))}
      {% set col = [def_color[1][1],def_color[1][2],def_color[1][3],def_color[1][4]] %}
    {% endif %}
  {% else %}
    {% set col = res_color %}
  {% endif %}
  ##### store new variable values #####
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=sync VALUE={sync}
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=time VALUE={time}
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=res_color VALUE="{pri_color}"
  SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=pri_color VALUE="{col}"
  ##### update to new color and start or stop blinking #####
  UPDATE_DELAYED_GCODE ID=_BLINK_DELAY DURATION={time}
  SET_LED LED=neo_display RED={col[0]} GREEN={col[1]}  BLUE={col[2]} WHITE={col[3]} TRANSMIT=0 SYNC={sync}
  SET_LED LED=neo_display RED={col[0]} GREEN={col[1]}  BLUE={col[2]} WHITE={col[3]} TRANSMIT=1 SYNC={sync}
    
[delayed_gcode _BLINK_DELAY]
gcode:
  ##### get variables #####
  {% set col1 = printer["gcode_macro _LCD_KNOB"].pri_color %}
  {% set col2 = printer["gcode_macro _LCD_KNOB"].sec_color %}
  {% set sync=printer["gcode_macro _LCD_KNOB"].sync|int %}
  {% set index = printer["gcode_macro _LCD_KNOB"].index|int %}
  {% set time =  printer["gcode_macro _LCD_KNOB"].time|float %}
  ##### end of definition #####
  {% if index == 2 %}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=index VALUE=3
    SET_LED LED=neo_display RED={col1[0]} GREEN={col1[1]} BLUE={col1[2]} WHITE={col1[3]} TRANSMIT=0 SYNC={sync}
    SET_LED LED=neo_display RED={col2[0]} GREEN={col2[1]} BLUE={col2[2]} WHITE={col2[3]} TRANSMIT=1 SYNC={sync}
  {% else %}
    SET_GCODE_VARIABLE MACRO=_LCD_KNOB VARIABLE=index VALUE=2
    SET_LED LED=neo_display RED={col2[0]} GREEN={col2[1]} BLUE={col2[2]} WHITE={col2[3]} TRANSMIT=0 SYNC={sync}
    SET_LED LED=neo_display RED={col1[0]} GREEN={col1[1]} BLUE={col1[2]} WHITE={col1[3]} TRANSMIT=1 SYNC={sync}
  {% endif %}
  UPDATE_DELAYED_GCODE ID=_BLINK_DELAY DURATION={time}

[gcode_macro DISPLAY]
description: Toggle Display backlight
variable_state: 'on'
gcode:
  {% if printer["gcode_macro DISPLAY"].state == 'on' %}
    _DISPLAY_OFF
  {% else %}
    _DISPLAY_ON
  {% endif %}
  _DISPLAY_STATE
    
[gcode_macro _DISPLAY_STATE]
description: Helper: Print display backlight state
gcode:
  {action_respond_info("LCD display %s" % (printer["gcode_macro DISPLAY"].state))}

[gcode_macro _DISPLAY_OFF]
description: Helper: Display backlight off
gcode:
  ##### get hardware enables #####
  {% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
  ##### switch off if not already in menu #####
  {% if printer.menu.running|lower == 'false' and ena_neo == 'true' %}
    SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"off"'
    SET_LED LED=neo_display RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=1 TRANSMIT=1 SYNC=0
  {% endif %}

[gcode_macro _DISPLAY_ON]
description: Helper: Display backlight on
gcode:
  ##### get hardware enables #####
  {% set ena_neo = printer['gcode_macro _USER_VARIABLE'].neo_display|lower %}
  ##### end of definiton #####
  {% if ena_neo == 'true' %}
    SET_GCODE_VARIABLE MACRO=DISPLAY VARIABLE=state VALUE='"on"'
    SET_LED LED=neo_display RED=0.8 GREEN=0.8 BLUE=1.0 WHITE=0.5 INDEX=1 TRANSMIT=1 SYNC=0
  {% endif %}
 
  
